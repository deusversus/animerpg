{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aidm.dev/schemas/memory_thread_schema.json",
  "title": "AIDM Memory Thread Schema",
  "description": "Defines the hierarchical memory organization system for AIDM, including prioritization, compression, and retrieval mechanisms.",
  "type": "object",
  "required": [
    "schema_version",
    "thread_id",
    "category",
    "content",
    "heat_index",
    "metadata"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for migration compatibility tracking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "2.0.0"
    },
    "thread_id": {
      "type": "string",
      "description": "Unique identifier for this memory thread",
      "pattern": "^mem_[a-z0-9_]+_\\d+$"
    },
    "category": {
      "type": "string",
      "enum": [
        "core",
        "character_state",
        "relationships",
        "quests",
        "world_events",
        "consequences"
      ],
      "description": "Memory hierarchy category - determines priority and retention"
    },
    "content": {
      "type": "object",
      "description": "The actual memory data",
      "required": ["summary", "details"],
      "properties": {
        "summary": {
          "type": "string",
          "description": "Brief one-sentence summary (max 100 chars)",
          "maxLength": 100
        },
        "details": {
          "type": "string",
          "description": "Full memory content with context"
        },
        "emotional_weight": {
          "type": "string",
          "enum": ["trivial", "minor", "moderate", "significant", "profound"],
          "description": "Emotional impact on player/world"
        },
        "related_entities": {
          "type": "array",
          "description": "NPCs, locations, items involved in this memory",
          "items": {
            "type": "object",
            "properties": {
              "entity_type": {
                "type": "string",
                "enum": ["npc", "location", "item", "faction", "event", "concept"]
              },
              "entity_id": {
                "type": "string"
              },
              "entity_name": {
                "type": "string"
              },
              "role_in_memory": {
                "type": "string",
                "description": "How this entity is involved"
              }
            }
          }
        },
        "keywords": {
          "type": "array",
          "description": "Searchable terms for quick retrieval",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "heat_index": {
      "type": "object",
      "description": "Priority scoring for memory retention and retrieval",
      "required": ["current_score", "base_score"],
      "properties": {
        "current_score": {
          "type": "number",
          "description": "Current heat (0-100, decays over time)",
          "minimum": 0,
          "maximum": 100
        },
        "base_score": {
          "type": "number",
          "description": "Minimum heat this memory maintains (prevents full decay)",
          "minimum": 0,
          "maximum": 100
        },
        "decay_rate": {
          "type": "string",
          "enum": ["none", "slow", "normal", "fast"],
          "description": "How quickly heat drops if not referenced",
          "default": "normal"
        },
        "last_accessed": {
          "type": "string",
          "format": "date-time",
          "description": "Last time this memory was retrieved or referenced"
        },
        "access_count": {
          "type": "integer",
          "description": "Total times this memory has been accessed",
          "minimum": 0
        },
        "boost_factors": {
          "type": "array",
          "description": "Reasons for increased heat",
          "items": {
            "type": "object",
            "properties": {
              "factor": {
                "type": "string",
                "description": "What caused the boost (recent_reference, player_initiated, plot_critical, etc.)"
              },
              "boost_amount": {
                "type": "number",
                "description": "How much heat this adds",
                "minimum": 0
              },
              "expires": {
                "type": "string",
                "format": "date-time",
                "description": "When this boost wears off (if temporary)"
              }
            }
          }
        }
      }
    },
    "temporal_context": {
      "type": "object",
      "description": "When and where this memory originated",
      "required": ["created_date"],
      "properties": {
        "created_date": {
          "type": "string",
          "format": "date-time",
          "description": "Real-world timestamp when memory was created"
        },
        "in_game_date": {
          "type": "string",
          "description": "In-game date when event occurred"
        },
        "session_number": {
          "type": "integer",
          "description": "Which session this memory is from",
          "minimum": 0
        },
        "location": {
          "type": "string",
          "description": "Where this event took place"
        },
        "time_of_day": {
          "type": "string",
          "enum": ["dawn", "morning", "midday", "afternoon", "evening", "night", "midnight"],
          "description": "Time when event occurred"
        }
      }
    },
    "relationships": {
      "type": "object",
      "description": "How this memory connects to other memories",
      "properties": {
        "parent_thread": {
          "type": "string",
          "description": "Thread ID this memory is a continuation of"
        },
        "child_threads": {
          "type": "array",
          "description": "Thread IDs that branch from this memory",
          "items": {
            "type": "string"
          }
        },
        "related_threads": {
          "type": "array",
          "description": "Other memories connected to this one",
          "items": {
            "type": "object",
            "properties": {
              "thread_id": {
                "type": "string"
              },
              "relationship_type": {
                "type": "string",
                "enum": [
                  "caused_by",
                  "leads_to",
                  "contradicts",
                  "supports",
                  "references",
                  "parallel_to"
                ]
              },
              "strength": {
                "type": "string",
                "enum": ["weak", "moderate", "strong"],
                "description": "How closely related"
              }
            }
          }
        },
        "superseded_by": {
          "type": "string",
          "description": "Thread ID that replaces/updates this memory (for outdated info)"
        }
      }
    },
    "flags": {
      "type": "object",
      "description": "Special markers for AIDM processing",
      "properties": {
        "immutable": {
          "type": "boolean",
          "description": "Cannot be changed or compressed",
          "default": false
        },
        "plot_critical": {
          "type": "boolean",
          "description": "Essential for main narrative",
          "default": false
        },
        "player_initiated": {
          "type": "boolean",
          "description": "Player specifically asked to remember this",
          "default": false
        },
        "compressed": {
          "type": "boolean",
          "description": "This is a compressed summary of multiple memories",
          "default": false
        },
        "requires_verification": {
          "type": "boolean",
          "description": "AIDM should double-check this memory before using it",
          "default": false
        },
        "sensitive": {
          "type": "boolean",
          "description": "Contains mature/triggering content (respect player preferences)",
          "default": false
        },
        "hidden_from_player": {
          "type": "boolean",
          "description": "Player hasn't discovered this information yet",
          "default": false
        }
      }
    },
    "compression": {
      "type": "object",
      "description": "Data about compression status and history",
      "properties": {
        "compression_level": {
          "type": "integer",
          "description": "How many times this has been compressed (0 = original)",
          "minimum": 0,
          "default": 0
        },
        "original_threads": {
          "type": "array",
          "description": "Thread IDs that were merged into this compressed memory",
          "items": {
            "type": "string"
          }
        },
        "compression_date": {
          "type": "string",
          "format": "date-time",
          "description": "When compression occurred"
        },
        "pre_compression_summary": {
          "type": "string",
          "description": "What the original memory said before compression"
        },
        "information_loss": {
          "type": "string",
          "enum": ["none", "minimal", "moderate", "significant"],
          "description": "How much detail was lost in compression"
        },
        "recoverable": {
          "type": "boolean",
          "description": "Whether original detail can be restored if needed",
          "default": false
        }
      }
    },
    "category_specific": {
      "type": "object",
      "description": "Additional data based on category",
      "oneOf": [
        {
          "title": "Core Memory",
          "description": "Immutable foundational memories",
          "properties": {
            "category_type": {
              "const": "core"
            },
            "core_type": {
              "type": "string",
              "enum": [
                "origin_story",
                "unique_ability",
                "world_foundation",
                "campaign_premise",
                "immutable_rule"
              ]
            },
            "protected": {
              "type": "boolean",
              "description": "Cannot be altered by any means",
              "default": true
            }
          }
        },
        {
          "title": "Character State Memory",
          "description": "Mutable character progression",
          "properties": {
            "category_type": {
              "const": "character_state"
            },
            "state_type": {
              "type": "string",
              "enum": [
                "level_up",
                "skill_learned",
                "attribute_change",
                "status_effect",
                "equipment_change",
                "resource_change"
              ]
            },
            "current_value": {
              "type": "string",
              "description": "Current state of what changed"
            },
            "previous_value": {
              "type": "string",
              "description": "What it was before"
            }
          }
        },
        {
          "title": "Relationship Memory",
          "description": "NPC interaction history",
          "properties": {
            "category_type": {
              "const": "relationships"
            },
            "npc_id": {
              "type": "string"
            },
            "affinity_change": {
              "type": "integer",
              "description": "How much relationship changed"
            },
            "new_affinity": {
              "type": "integer",
              "description": "Current affinity after this event"
            },
            "relationship_milestone": {
              "type": "boolean",
              "description": "Did this unlock new relationship tier?",
              "default": false
            }
          }
        },
        {
          "title": "Quest Memory",
          "description": "Quest progression events",
          "properties": {
            "category_type": {
              "const": "quests"
            },
            "quest_id": {
              "type": "string"
            },
            "quest_event": {
              "type": "string",
              "enum": [
                "accepted",
                "objective_completed",
                "failed",
                "completed",
                "abandoned",
                "updated"
              ]
            },
            "objective_id": {
              "type": "string",
              "description": "Specific objective if applicable"
            }
          }
        },
        {
          "title": "World Event Memory",
          "description": "Changes to world state",
          "properties": {
            "category_type": {
              "const": "world_events"
            },
            "event_scope": {
              "type": "string",
              "enum": ["personal", "local", "regional", "national", "global", "cosmic"],
              "description": "How wide-reaching this event is"
            },
            "affected_locations": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "affected_factions": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "irreversible": {
              "type": "boolean",
              "description": "Cannot be undone",
              "default": false
            }
          }
        },
        {
          "title": "Consequence Memory",
          "description": "Long-term ripple effects",
          "properties": {
            "category_type": {
              "const": "consequences"
            },
            "source_thread": {
              "type": "string",
              "description": "Memory thread that caused this consequence"
            },
            "consequence_type": {
              "type": "string",
              "enum": [
                "npc_reaction",
                "faction_response",
                "world_change",
                "quest_branch",
                "reputation_shift",
                "economic_impact",
                "narrative_drift"
              ]
            },
            "time_delay": {
              "type": "string",
              "description": "How long after source event this manifests"
            },
            "visibility": {
              "type": "string",
              "enum": ["obvious", "subtle", "hidden"],
              "description": "How apparent this consequence is"
            }
          }
        }
      ]
    },
    "retrieval_triggers": {
      "type": "array",
      "description": "Conditions that should bring this memory to AIDM's attention",
      "items": {
        "type": "object",
        "properties": {
          "trigger_type": {
            "type": "string",
            "enum": [
              "location_visited",
              "npc_encountered",
              "item_used",
              "keyword_mentioned",
              "time_elapsed",
              "condition_met",
              "random_chance"
            ]
          },
          "trigger_value": {
            "type": "string",
            "description": "Specific value for trigger (location ID, NPC name, etc.)"
          },
          "priority": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"],
            "description": "How important is this trigger"
          }
        }
      }
    },
    "aidm_directives": {
      "type": "object",
      "description": "Instructions for how AIDM should use this memory",
      "properties": {
        "auto_inject": {
          "type": "boolean",
          "description": "Include in context automatically when triggered",
          "default": false
        },
        "requires_player_knowledge": {
          "type": "boolean",
          "description": "Only use if player knows this information",
          "default": true
        },
        "update_on_contradiction": {
          "type": "string",
          "enum": ["ignore", "flag", "update", "create_new"],
          "description": "What to do if new info contradicts this memory"
        },
        "cross_reference_required": {
          "type": "boolean",
          "description": "Must verify against other memories before using",
          "default": false
        },
        "narrative_weight": {
          "type": "integer",
          "description": "How much this memory should influence future events (0-10)",
          "minimum": 0,
          "maximum": 10
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Meta-information about this memory thread",
      "required": ["version"],
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "created_by": {
          "type": "string",
          "enum": ["player_action", "aidm_inference", "world_event", "quest_system", "npc_action", "manual_entry"]
        },
        "confidence": {
          "type": "string",
          "enum": ["certain", "high", "medium", "low", "uncertain"],
          "description": "How confident AIDM is this memory is accurate"
        },
        "source": {
          "type": "string",
          "description": "Where this information came from"
        },
        "validation_required": {
          "type": "boolean",
          "description": "Needs verification before use",
          "default": false
        },
        "notes": {
          "type": "string",
          "description": "Developer notes about this memory"
        }
      }
    }
  }
}

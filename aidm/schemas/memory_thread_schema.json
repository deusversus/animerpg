{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aidm.dev/schemas/memory_thread_schema.json",
  "title": "AIDM Memory Thread Schema",
  "description": "Hierarchical memory: prioritization, compression, retrieval",
  "type": "object",
  "required": ["schema_version", "thread_id", "category", "content", "heat_index", "metadata"],
  "properties": {
    "schema_version": { "type": "string", "description": "Schema version", "pattern": "^\\d+\\.\\d+\\.\\d+$", "default": "2.0.0" },
    "thread_id": { "type": "string", "description": "Unique ID", "pattern": "^mem_[a-z0-9_]+_\\d+$" },
    "category": { "type": "string", "enum": ["core", "character_state", "relationships", "quests", "world_events", "consequences"], "description": "Hierarchy category (determines priority/retention)" },
    "content": {
      "type": "object",
      "description": "Memory data",
      "required": ["summary", "details"],
      "properties": {
        "summary": { "type": "string", "description": "One-sentence (max 100 chars)", "maxLength": 100 },
        "details": { "type": "string", "description": "Full content with context" },
        "emotional_weight": { "type": "string", "enum": ["trivial", "minor", "moderate", "significant", "profound"], "description": "Impact on player/world" },
        "related_entities": {
          "type": "array",
          "description": "NPCs, locations, items involved",
          "items": {
            "type": "object",
            "properties": {
              "entity_type": { "type": "string", "enum": ["npc", "location", "item", "faction", "event", "concept"] },
              "entity_id": { "type": "string" },
              "entity_name": { "type": "string" },
              "role_in_memory": { "type": "string" }
            }
          }
        },
        "keywords": { "type": "array", "description": "Searchable terms", "items": { "type": "string" } }
      }
    },
    "heat_index": {
      "type": "object",
      "description": "Priority scoring for retention/retrieval",
      "required": ["current_score", "base_score"],
      "properties": {
        "current_score": { "type": "number", "description": "Current heat (0-100, decays over time)", "minimum": 0, "maximum": 100 },
        "base_score": { "type": "number", "description": "Minimum heat (prevents full decay)", "minimum": 0, "maximum": 100 },
        "decay_rate": { "type": "string", "enum": ["none", "slow", "normal", "fast"], "description": "Heat drop speed when not referenced", "default": "normal" },
        "last_accessed": { "type": "string", "format": "date-time", "description": "Last retrieval/reference" },
        "access_count": { "type": "integer", "description": "Total accesses", "minimum": 0 },
        "boost_factors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "factor": { "type": "string", "description": "e.g., recent_reference, player_initiated, plot_critical" },
              "boost_amount": { "type": "number", "description": "Heat added", "minimum": 0 },
              "expires": { "type": "string", "format": "date-time", "description": "When boost wears off (if temporary)" }
            }
          }
        }
      }
    },
    "temporal_context": {
      "type": "object",
      "description": "When/where memory originated",
      "required": ["created_date"],
      "properties": {
        "created_date": { "type": "string", "format": "date-time" },
        "in_game_date": { "type": "string" },
        "session_number": { "type": "integer", "minimum": 0 },
        "location": { "type": "string" },
        "time_of_day": { "type": "string", "enum": ["dawn", "morning", "midday", "afternoon", "evening", "night", "midnight"] }
      }
    },
    "relationships": {
      "type": "object",
      "description": "Connections to other memories",
      "properties": {
        "parent_thread": { "type": "string", "description": "Thread ID this continues" },
        "child_threads": { "type": "array", "description": "Thread IDs branching from this", "items": { "type": "string" } },
        "related_threads": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "thread_id": { "type": "string" },
              "relationship_type": { "type": "string", "enum": ["caused_by", "leads_to", "contradicts", "supports", "references", "parallel_to"] },
              "strength": { "type": "string", "enum": ["weak", "moderate", "strong"] }
            }
          }
        },
        "superseded_by": { "type": "string", "description": "Thread ID replacing this (outdated info)" }
      }
    },
    "flags": {
      "type": "object",
      "description": "AIDM processing markers",
      "properties": {
        "immutable": { "type": "boolean", "description": "Cannot change/compress", "default": false },
        "plot_critical": { "type": "boolean", "description": "Essential for main narrative", "default": false },
        "player_initiated": { "type": "boolean", "description": "Player asked to remember", "default": false },
        "compressed": { "type": "boolean", "description": "Summary of multiple memories", "default": false },
        "requires_verification": { "type": "boolean", "description": "Double-check before using", "default": false },
        "sensitive": { "type": "boolean", "description": "Mature/triggering content", "default": false },
        "hidden_from_player": { "type": "boolean", "description": "Not yet discovered", "default": false }
      }
    },
    "compression": {
      "type": "object",
      "description": "Compression status/history",
      "properties": {
        "compression_level": { "type": "integer", "description": "Times compressed (0=original)", "minimum": 0, "default": 0 },
        "original_threads": { "type": "array", "description": "Thread IDs merged here", "items": { "type": "string" } },
        "compression_date": { "type": "string", "format": "date-time" },
        "pre_compression_summary": { "type": "string", "description": "Original before compression" },
        "information_loss": { "type": "string", "enum": ["none", "minimal", "moderate", "significant"] },
        "recoverable": { "type": "boolean", "description": "Can original detail be restored", "default": false }
      }
    },
    "category_specific": {
      "type": "object",
      "description": "Category-based data",
      "oneOf": [
        {
          "title": "Core Memory",
          "description": "Immutable foundational",
          "properties": {
            "category_type": { "const": "core" },
            "core_type": { "type": "string", "enum": ["origin_story", "unique_ability", "world_foundation", "campaign_premise", "immutable_rule"] },
            "protected": { "type": "boolean", "description": "Cannot alter", "default": true }
          }
        },
        {
          "title": "Character State Memory",
          "description": "Mutable progression",
          "properties": {
            "category_type": { "const": "character_state" },
            "state_type": { "type": "string", "enum": ["level_up", "skill_learned", "attribute_change", "status_effect", "equipment_change", "resource_change"] },
            "current_value": { "type": "string" },
            "previous_value": { "type": "string" }
          }
        },
        {
          "title": "Relationship Memory",
          "description": "NPC interaction history",
          "properties": {
            "category_type": { "const": "relationships" },
            "npc_id": { "type": "string" },
            "affinity_change": { "type": "integer" },
            "new_affinity": { "type": "integer" },
            "relationship_milestone": { "type": "boolean", "description": "Unlocked new tier", "default": false }
          }
        },
        {
          "title": "Quest Memory",
          "description": "Quest progression",
          "properties": {
            "category_type": { "const": "quests" },
            "quest_id": { "type": "string" },
            "quest_event": { "type": "string", "enum": ["accepted", "objective_completed", "failed", "completed", "abandoned", "updated"] },
            "objective_id": { "type": "string", "description": "Specific objective (if applicable)" }
          }
        },
        {
          "title": "World Event Memory",
          "description": "World state changes",
          "properties": {
            "category_type": { "const": "world_events" },
            "event_scope": { "type": "string", "enum": ["personal", "local", "regional", "national", "global", "cosmic"], "description": "Event reach" },
            "affected_locations": { "type": "array", "items": { "type": "string" } },
            "affected_factions": { "type": "array", "items": { "type": "string" } },
            "irreversible": { "type": "boolean", "description": "Cannot undo", "default": false }
          }
        },
        {
          "title": "Consequence Memory",
          "description": "Long-term ripple effects",
          "properties": {
            "category_type": { "const": "consequences" },
            "source_thread": { "type": "string", "description": "Memory thread causing this" },
            "consequence_type": { "type": "string", "enum": ["npc_reaction", "faction_response", "world_change", "quest_branch", "reputation_shift", "economic_impact", "narrative_drift"] },
            "time_delay": { "type": "string", "description": "How long after source event" },
            "visibility": { "type": "string", "enum": ["obvious", "subtle", "hidden"], "description": "How apparent" }
          }
        }
      ]
    },
    "retrieval_triggers": {
      "type": "array",
      "description": "Conditions triggering memory recall",
      "items": {
        "type": "object",
        "properties": {
          "trigger_type": { "type": "string", "enum": ["location_visited", "npc_encountered", "item_used", "keyword_mentioned", "time_elapsed", "condition_met", "random_chance"] },
          "trigger_value": { "type": "string", "description": "e.g., location ID, NPC name" },
          "priority": { "type": "string", "enum": ["low", "medium", "high", "critical"] }
        }
      }
    },
    "aidm_directives": {
      "type": "object",
      "description": "AIDM usage instructions",
      "properties": {
        "auto_inject": { "type": "boolean", "description": "Include in context when triggered", "default": false },
        "requires_player_knowledge": { "type": "boolean", "description": "Only use if player knows", "default": true },
        "update_on_contradiction": { "type": "string", "enum": ["ignore", "flag", "update", "create_new"], "description": "Action when new info contradicts" },
        "cross_reference_required": { "type": "boolean", "description": "Verify against other memories", "default": false },
        "narrative_weight": { "type": "integer", "description": "Influence on future events (0-10)", "minimum": 0, "maximum": 10 }
      }
    },
    "metadata": {
      "type": "object",
      "required": ["version"],
      "properties": {
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "created_by": { "type": "string", "enum": ["player_action", "aidm_inference", "world_event", "quest_system", "npc_action", "manual_entry"] },
        "confidence": { "type": "string", "enum": ["certain", "high", "medium", "low", "uncertain"], "description": "AIDM confidence in accuracy" },
        "source": { "type": "string" },
        "validation_required": { "type": "boolean", "default": false },
        "notes": { "type": "string" }
      }
    }
  }
}

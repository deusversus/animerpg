{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AIDM Session Export Schema",
  "description": "Complete save file format for AIDM v2 system - contains everything needed to resume gameplay",
  "type": "object",
  "required": [
    "export_version",
    "export_timestamp",
    "session_metadata",
    "character",
    "world_state",
    "npcs",
    "memory_threads"
  ],
  "properties": {
    "export_version": {
      "type": "string",
      "description": "Schema version for compatibility checking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "examples": ["2.0.0"]
    },
    "export_timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "When this export was created"
    },
    
    "session_metadata": {
      "type": "object",
      "description": "Information about the gameplay session",
      "required": ["session_id", "campaign_name", "total_sessions", "total_playtime"],
      "properties": {
        "session_id": {
          "type": "string",
          "description": "Unique identifier for this save",
          "pattern": "^session_[a-zA-Z0-9]{16}$"
        },
        "campaign_name": {
          "type": "string",
          "description": "Player-chosen campaign name",
          "maxLength": 200
        },
        "total_sessions": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of play sessions"
        },
        "total_playtime": {
          "type": "integer",
          "minimum": 0,
          "description": "Total minutes played"
        },
        "last_session_date": {
          "type": "string",
          "format": "date-time"
        },
        "aidm_version": {
          "type": "string",
          "description": "AIDM system version used"
        },
        "player_notes": {
          "type": "string",
          "description": "Player's notes about this save",
          "maxLength": 5000
        },
        "save_point": {
          "type": "string",
          "description": "Brief description of where the game left off",
          "maxLength": 500
        }
      }
    },
    
    "character": {
      "description": "Complete character state - follows character_schema.json",
      "$ref": "character_schema.json"
    },
    
    "world_state": {
      "description": "Complete world state - follows world_state_schema.json",
      "$ref": "world_state_schema.json"
    },
    
    "npcs": {
      "type": "array",
      "description": "All encountered NPCs with full data",
      "items": {
        "description": "NPC data - follows npc_schema.json",
        "$ref": "npc_schema.json"
      }
    },
    
    "memory_threads": {
      "type": "object",
      "description": "Hierarchical memory system containing all session context",
      "required": ["core", "character_state", "relationships", "quests", "world_events", "consequences"],
      "properties": {
        "core": {
          "type": "array",
          "description": "Immutable core memories (character creation, unique abilities, world origin)",
          "items": {
            "type": "object",
            "required": ["thread_id", "type", "priority", "content", "created_at"],
            "properties": {
              "thread_id": {"type": "string"},
              "type": {"type": "string", "enum": ["origin", "unique_ability", "world_foundation"]},
              "priority": {"type": "integer", "minimum": 1, "maximum": 10},
              "content": {"type": "string"},
              "created_at": {"type": "string", "format": "date-time"},
              "heat_index": {"type": "number", "minimum": 0, "maximum": 1, "description": "Importance weighting"}
            }
          }
        },
        "character_state": {
          "type": "array",
          "description": "Mutable character state memories (HP/MP/SP changes, inventory, conditions)",
          "items": {
            "type": "object",
            "required": ["thread_id", "content", "last_updated"],
            "properties": {
              "thread_id": {"type": "string"},
              "content": {"type": "string"},
              "last_updated": {"type": "string", "format": "date-time"},
              "heat_index": {"type": "number"}
            }
          }
        },
        "relationships": {
          "type": "array",
          "description": "NPC relationship memories",
          "items": {
            "type": "object",
            "required": ["thread_id", "npc_id", "npc_name", "interactions"],
            "properties": {
              "thread_id": {"type": "string"},
              "npc_id": {"type": "string"},
              "npc_name": {"type": "string"},
              "current_affinity": {"type": "integer", "minimum": -100, "maximum": 100},
              "interactions": {
                "type": "array",
                "description": "Significant interaction history",
                "items": {
                  "type": "object",
                  "properties": {
                    "summary": {"type": "string"},
                    "affinity_change": {"type": "integer"},
                    "emotional_tags": {"type": "array", "items": {"type": "string"}},
                    "timestamp": {"type": "string", "format": "date-time"}
                  }
                }
              },
              "heat_index": {"type": "number"}
            }
          }
        },
        "quests": {
          "type": "array",
          "description": "Quest progression memories",
          "items": {
            "type": "object",
            "required": ["thread_id", "quest_id", "quest_name", "events"],
            "properties": {
              "thread_id": {"type": "string"},
              "quest_id": {"type": "string"},
              "quest_name": {"type": "string"},
              "status": {"type": "string", "enum": ["active", "completed", "failed"]},
              "events": {
                "type": "array",
                "description": "Key quest moments",
                "items": {
                  "type": "object",
                  "properties": {
                    "event": {"type": "string"},
                    "timestamp": {"type": "string", "format": "date-time"}
                  }
                }
              },
              "heat_index": {"type": "number"}
            }
          }
        },
        "world_events": {
          "type": "array",
          "description": "World state change memories",
          "items": {
            "type": "object",
            "required": ["thread_id", "event", "timestamp"],
            "properties": {
              "thread_id": {"type": "string"},
              "event": {"type": "string"},
              "location": {"type": "string"},
              "involved_factions": {"type": "array", "items": {"type": "string"}},
              "player_involved": {"type": "boolean"},
              "consequences": {"type": "array", "items": {"type": "string"}},
              "timestamp": {"type": "string", "format": "date-time"},
              "heat_index": {"type": "number"}
            }
          }
        },
        "consequences": {
          "type": "array",
          "description": "Long-term consequence tracking (moral choices, ripple effects)",
          "items": {
            "type": "object",
            "required": ["thread_id", "original_action", "consequences"],
            "properties": {
              "thread_id": {"type": "string"},
              "original_action": {
                "type": "object",
                "properties": {
                  "description": {"type": "string"},
                  "timestamp": {"type": "string", "format": "date-time"}
                }
              },
              "consequences": {
                "type": "array",
                "description": "Cascading effects of the action",
                "items": {
                  "type": "object",
                  "properties": {
                    "description": {"type": "string"},
                    "scope": {"type": "string", "enum": ["personal", "local", "regional", "global"]},
                    "manifested_at": {"type": "string", "format": "date-time"}
                  }
                }
              },
              "heat_index": {"type": "number"}
            }
          }
        },
        "compressed_memories": {
          "type": "array",
          "description": "Older memories compressed to save context space",
          "items": {
            "type": "object",
            "properties": {
              "summary": {"type": "string", "description": "Condensed version of multiple threads"},
              "original_thread_ids": {"type": "array", "items": {"type": "string"}},
              "compressed_at": {"type": "string", "format": "date-time"}
            }
          }
        }
      }
    },
    
    "recent_narrative": {
      "type": "object",
      "description": "Last few turns of gameplay for context continuity",
      "properties": {
        "last_player_input": {"type": "string"},
        "last_aidm_response": {"type": "string"},
        "recent_exchanges": {
          "type": "array",
          "description": "Last 5-10 player/AIDM exchanges",
          "items": {
            "type": "object",
            "properties": {
              "player": {"type": "string"},
              "aidm": {"type": "string"},
              "timestamp": {"type": "string", "format": "date-time"}
            }
          }
        },
        "active_scene": {
          "type": "string",
          "description": "Current scene description for continuity"
        }
      }
    },
    
    "system_state": {
      "type": "object",
      "description": "Internal AIDM system state",
      "properties": {
        "loaded_instruction_files": {
          "type": "array",
          "description": "Which instruction files were active",
          "items": {"type": "string"}
        },
        "loaded_libraries": {
          "type": "array",
          "description": "Which library files were loaded",
          "items": {"type": "string"}
        },
        "active_power_systems": {
          "type": "array",
          "description": "Which power systems are in use",
          "items": {"type": "string"}
        },
        "active_narrative_profile": {
          "description": "Current narrative DNA profile for storytelling consistency - ensures genre-authentic narration persists across save/load",
          "$ref": "narrative_profile_schema.json"
        },
        "player_preferences": {
          "type": "object",
          "description": "Player calibration settings",
          "properties": {
            "content_preferences": {
              "type": "object",
              "properties": {
                "tragedy": {"type": "string", "enum": ["none", "light", "moderate", "heavy"]},
                "romance": {"type": "string", "enum": ["none", "light", "moderate", "heavy"]},
                "violence": {"type": "string", "enum": ["none", "light", "moderate", "heavy", "extreme"]},
                "explicitness": {"type": "string", "enum": ["fade_to_black", "suggestive", "moderate", "explicit"]}
              }
            },
            "gameplay_preferences": {
              "type": "object",
              "properties": {
                "combat_complexity": {"type": "string", "enum": ["narrative", "simple", "tactical", "advanced"]},
                "difficulty": {"type": "string", "enum": ["power_fantasy", "easy", "normal", "hard", "brutal"]},
                "pacing": {"type": "string", "enum": ["episodic", "moderate", "long_arc"]}
              }
            }
          }
        },
        "validation_checksum": {
          "type": "string",
          "description": "Hash of critical data for integrity checking"
        }
      }
    },
    
    "compatibility_notes": {
      "type": "string",
      "description": "Special notes about loading this save (missing features, version warnings, etc.)",
      "maxLength": 1000
    }
  }
}

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aidm.dev/schemas/quest_schema.json",
  "title": "AIDM Quest Schema",
  "description": "Structured quest system with objectives, rewards, branching paths, dependencies, and time limits",
  "type": "object",
  "required": [
    "schema_version",
    "quest_id",
    "title",
    "description",
    "objectives",
    "rewards",
    "status",
    "metadata"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for migration compatibility tracking",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "2.1.0"
    },
    "quest_id": {
      "type": "string",
      "description": "Unique quest identifier",
      "pattern": "^quest_[a-z0-9_]+$"
    },
    "title": {
      "type": "string",
      "description": "Quest name displayed to player",
      "maxLength": 100
    },
    "description": {
      "type": "string",
      "description": "Quest background, context, and lore"
    },
    "quest_giver": {
      "type": ["string", "null"],
      "description": "NPC ID who gave quest (null if no specific NPC)",
      "pattern": "^npc_[a-z0-9_]+$"
    },
    "objectives": {
      "type": "array",
      "description": "List of quest objectives (supports branching and dependencies)",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["objective_id", "description", "completed", "required"],
        "properties": {
          "objective_id": {
            "type": "string",
            "description": "Unique identifier for this objective",
            "pattern": "^obj_[a-z0-9_]+$"
          },
          "description": {
            "type": "string",
            "description": "What player must do (shown in quest log)"
          },
          "completed": {
            "type": "boolean",
            "description": "Whether this objective is done",
            "default": false
          },
          "progress": {
            "type": "number",
            "description": "Current progress (e.g., 3 out of 10 enemies defeated)",
            "minimum": 0
          },
          "progress_max": {
            "type": "number",
            "description": "Target for completion (e.g., 10 enemies total)",
            "minimum": 1
          },
          "required": {
            "type": "boolean",
            "description": "Must complete to finish quest (false = optional bonus objective)",
            "default": true
          },
          "dependencies": {
            "type": "array",
            "description": "Objective IDs that must complete before this unlocks",
            "items": {
              "type": "string",
              "pattern": "^obj_[a-z0-9_]+$"
            },
            "default": []
          },
          "mutually_exclusive_with": {
            "type": "array",
            "description": "Objective IDs that cannot be completed if this one is (branching choice)",
            "items": {
              "type": "string",
              "pattern": "^obj_[a-z0-9_]+$"
            },
            "default": []
          },
          "hidden": {
            "type": "boolean",
            "description": "Hidden objective (not shown until unlocked)",
            "default": false
          }
        }
      }
    },
    "rewards": {
      "type": "object",
      "description": "Quest completion rewards",
      "properties": {
        "xp": {
          "type": "number",
          "description": "Experience points awarded",
          "minimum": 0
        },
        "items": {
          "type": "array",
          "description": "Item IDs awarded to player inventory",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "currency": {
          "type": "object",
          "description": "Currency rewards (currency_type: amount)",
          "additionalProperties": {
            "type": "number",
            "minimum": 0
          },
          "default": {}
        },
        "reputation": {
          "type": "object",
          "description": "Faction reputation changes (faction_id: +/- amount)",
          "additionalProperties": {
            "type": "number"
          },
          "default": {}
        },
        "skills": {
          "type": "array",
          "description": "Skills unlocked or upgraded",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "unlocks": {
          "type": "array",
          "description": "Quest IDs unlocked on completion (quest chains)",
          "items": {
            "type": "string",
            "pattern": "^quest_[a-z0-9_]+$"
          },
          "default": []
        }
      }
    },
    "status": {
      "type": "string",
      "enum": ["available", "active", "in_progress", "ready_to_complete", "completed", "failed"],
      "description": "Quest state: available (offered but not accepted), active (accepted), in_progress (objectives being worked on), ready_to_complete (all required objectives done), completed (turned in), failed (auto-failed or player gave up)",
      "default": "available"
    },
    "branching": {
      "type": "object",
      "description": "Quest branching and dependency data",
      "properties": {
        "choices": {
          "type": "array",
          "description": "Decision points that affect quest outcome",
          "items": {
            "type": "object",
            "required": ["choice_id", "description"],
            "properties": {
              "choice_id": {
                "type": "string",
                "description": "Unique choice identifier"
              },
              "description": {
                "type": "string",
                "description": "What this choice represents"
              },
              "unlocks_objectives": {
                "type": "array",
                "description": "Objective IDs revealed if this choice made",
                "items": {
                  "type": "string",
                  "pattern": "^obj_[a-z0-9_]+$"
                },
                "default": []
              },
              "blocks_objectives": {
                "type": "array",
                "description": "Objective IDs that become impossible if this choice made",
                "items": {
                  "type": "string",
                  "pattern": "^obj_[a-z0-9_]+$"
                },
                "default": []
              },
              "reputation_impact": {
                "type": "object",
                "description": "Faction reputation changes from this choice",
                "additionalProperties": {
                  "type": "number"
                }
              }
            }
          },
          "default": []
        },
        "parent_quest": {
          "type": ["string", "null"],
          "description": "Quest ID this is a follow-up to (quest chains)",
          "pattern": "^quest_[a-z0-9_]+$"
        },
        "child_quests": {
          "type": "array",
          "description": "Quests unlocked by completing this one",
          "items": {
            "type": "string",
            "pattern": "^quest_[a-z0-9_]+$"
          },
          "default": []
        }
      }
    },
    "time_limit": {
      "type": ["string", "null"],
      "format": "date-time",
      "description": "ISO 8601 deadline for quest completion (null = no time limit)"
    },
    "fail_conditions": {
      "type": "array",
      "description": "Conditions that auto-fail quest if triggered",
      "items": {
        "type": "object",
        "required": ["condition_type", "description"],
        "properties": {
          "condition_type": {
            "type": "string",
            "enum": ["npc_death", "time_expired", "location_destroyed", "item_lost", "reputation_threshold", "custom"],
            "description": "Type of failure trigger"
          },
          "description": {
            "type": "string",
            "description": "Human-readable explanation of fail condition"
          },
          "parameters": {
            "type": "object",
            "description": "Condition-specific data (e.g., npc_id for npc_death, item_id for item_lost, faction_id + threshold for reputation)",
            "additionalProperties": true
          }
        }
      },
      "default": []
    },
    "quest_category": {
      "type": "string",
      "enum": ["main", "side", "faction", "personal", "daily", "event", "tutorial"],
      "description": "Quest type for organization and filtering",
      "default": "side"
    },
    "difficulty": {
      "type": "string",
      "enum": ["trivial", "easy", "moderate", "hard", "epic", "legendary"],
      "description": "Quest difficulty tier (affects XP scaling)",
      "default": "moderate"
    },
    "location": {
      "type": ["string", "null"],
      "description": "Primary location for quest (if applicable)"
    },
    "metadata": {
      "type": "object",
      "description": "Quest lifecycle tracking",
      "required": ["created_at", "accepted_at"],
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time",
          "description": "When quest became available"
        },
        "accepted_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When player accepted quest"
        },
        "completed_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When quest was completed"
        },
        "failed_at": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "When quest failed"
        },
        "failure_reason": {
          "type": ["string", "null"],
          "description": "Why quest failed (if applicable)"
        },
        "event_log": {
          "type": "array",
          "description": "Narrative progression events for this quest",
          "items": {
            "type": "object",
            "required": ["timestamp", "event"],
            "properties": {
              "timestamp": {
                "type": "string",
                "format": "date-time"
              },
              "event": {
                "type": "string",
                "description": "What happened (objective progress, choice made, etc.)"
              }
            }
          },
          "default": []
        }
      }
    }
  }
}

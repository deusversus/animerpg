{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aidm.dev/schemas/quest_schema.json",
  "title": "AIDM Quest Schema",
  "description": "Quest system: objectives, rewards, branching, dependencies, time limits",
  "type": "object",
  "required": ["schema_version", "quest_id", "title", "description", "objectives", "rewards", "status", "metadata"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for migration",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "default": "2.1.0"
    },
    "quest_id": {
      "type": "string",
      "description": "Unique quest ID",
      "pattern": "^quest_[a-z0-9_]+$"
    },
    "title": {"type": "string", "description": "Quest name (player-facing)", "maxLength": 100},
    "description": {"type": "string", "description": "Quest lore and context"},
    "quest_giver": {"type": ["string", "null"], "description": "NPC ID (null if none)", "pattern": "^npc_[a-z0-9_]+$"},
    "objectives": {
      "type": "array",
      "description": "Quest objectives (supports branching/dependencies)",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["objective_id", "description", "completed", "required"],
        "properties": {
          "objective_id": {"type": "string", "pattern": "^obj_[a-z0-9_]+$"},
          "description": {"type": "string", "description": "Task shown in quest log"},
          "completed": {"type": "boolean", "default": false},
          "progress": {"type": "number", "description": "Current (e.g., 3/10 enemies)", "minimum": 0},
          "progress_max": {"type": "number", "description": "Target (e.g., 10 total)", "minimum": 1},
          "required": {"type": "boolean", "description": "Must complete (false=optional bonus)", "default": true},
          "dependencies": {"type": "array", "description": "Obj IDs to unlock first", "items": {"type": "string", "pattern": "^obj_[a-z0-9_]+$"}, "default": []},
          "mutually_exclusive_with": {"type": "array", "description": "Obj IDs blocked by this choice", "items": {"type": "string", "pattern": "^obj_[a-z0-9_]+$"}, "default": []},
          "hidden": {"type": "boolean", "description": "Hidden until unlocked", "default": false}
        }
      }
    },
    "rewards": {
      "type": "object",
      "description": "Completion rewards",
      "properties": {
        "xp": {"type": "number", "minimum": 0},
        "items": {"type": "array", "description": "Item IDs to inventory", "items": {"type": "string"}, "default": []},
        "currency": {"type": "object", "description": "Currency: amount", "additionalProperties": {"type": "number", "minimum": 0}, "default": {}},
        "reputation": {"type": "object", "description": "Faction ID: +/- amount", "additionalProperties": {"type": "number"}, "default": {}},
        "skills": {"type": "array", "description": "Skills unlocked/upgraded", "items": {"type": "string"}, "default": []},
        "unlocks": {"type": "array", "description": "Quest IDs unlocked (chains)", "items": {"type": "string", "pattern": "^quest_[a-z0-9_]+$"}, "default": []}
      }
    },
    "status": {
      "type": "string",
      "enum": ["available", "active", "in_progress", "ready_to_complete", "completed", "failed"],
      "description": "available(offered)|active(accepted)|in_progress(working)|ready_to_complete(all done)|completed(turned in)|failed(auto-fail or gave up)",
      "default": "available"
    },
    "branching": {
      "type": "object",
      "description": "Quest branching and dependencies",
      "properties": {
        "choices": {
          "type": "array",
          "description": "Decision points affecting outcome",
          "items": {
            "type": "object",
            "required": ["choice_id", "description"],
            "properties": {
              "choice_id": {"type": "string"},
              "description": {"type": "string"},
              "unlocks_objectives": {"type": "array", "description": "Obj IDs revealed", "items": {"type": "string", "pattern": "^obj_[a-z0-9_]+$"}, "default": []},
              "blocks_objectives": {"type": "array", "description": "Obj IDs blocked", "items": {"type": "string", "pattern": "^obj_[a-z0-9_]+$"}, "default": []},
              "reputation_impact": {"type": "object", "description": "Faction rep changes", "additionalProperties": {"type": "number"}}
            }
          },
          "default": []
        },
        "parent_quest": {"type": ["string", "null"], "description": "Parent quest ID (chains)", "pattern": "^quest_[a-z0-9_]+$"},
        "child_quests": {"type": "array", "description": "Unlocked child quest IDs", "items": {"type": "string", "pattern": "^quest_[a-z0-9_]+$"}, "default": []}
      }
    },
    "time_limit": {"type": ["string", "null"], "format": "date-time", "description": "ISO 8601 deadline (null=no limit)"},
    "fail_conditions": {
      "type": "array",
      "description": "Auto-fail triggers",
      "items": {
        "type": "object",
        "required": ["condition_type", "description"],
        "properties": {
          "condition_type": {"type": "string", "enum": ["npc_death", "time_expired", "location_destroyed", "item_lost", "reputation_threshold", "custom"]},
          "description": {"type": "string"},
          "parameters": {"type": "object", "description": "Condition-specific data (npc_id, item_id, faction_id+threshold)", "additionalProperties": true}
        }
      },
      "default": []
    },
    "quest_category": {"type": "string", "enum": ["main", "side", "faction", "personal", "daily", "event", "tutorial"], "description": "Type for filtering", "default": "side"},
    "difficulty": {"type": "string", "enum": ["trivial", "easy", "moderate", "hard", "epic", "legendary"], "description": "Difficulty tier (affects XP)", "default": "moderate"},
    "location": {"type": ["string", "null"], "description": "Primary location (if applicable)"},
    "metadata": {
      "type": "object",
      "description": "Quest lifecycle tracking",
      "required": ["created_at", "accepted_at"],
      "properties": {
        "created_at": {"type": "string", "format": "date-time", "description": "When available"},
        "accepted_at": {"type": ["string", "null"], "format": "date-time", "description": "When accepted"},
        "completed_at": {"type": ["string", "null"], "format": "date-time", "description": "When completed"},
        "failed_at": {"type": ["string", "null"], "format": "date-time", "description": "When failed"},
        "failure_reason": {"type": ["string", "null"], "description": "Why failed (if applicable)"},
        "event_log": {
          "type": "array",
          "description": "Narrative progression events",
          "items": {
            "type": "object",
            "required": ["timestamp", "event"],
            "properties": {
              "timestamp": {"type": "string", "format": "date-time"},
              "event": {"type": "string", "description": "What happened (obj progress, choice made)"}
            }
          },
          "default": []
        }
      }
    }
  }
}

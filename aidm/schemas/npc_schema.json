{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://aidm.dev/schemas/npc_schema.json",
  "title": "AIDM NPC Schema",
  "description": "Structure for NPCs: personality, knowledge, relationships, behavior",
  "type": "object",
  "required": ["schema_version", "npc_id", "core_identity", "knowledge", "behavior", "relationships", "narrative_role", "metadata"],
  "properties": {
    "schema_version": { "type": "string", "description": "Schema version", "pattern": "^\\d+\\.\\d+\\.\\d+$", "default": "2.3.0" },
    "npc_id": { "type": "string", "description": "Unique ID", "pattern": "^npc_[a-z0-9_]+$" },
    "core_identity": {
      "type": "object",
      "description": "Immutable characteristics",
      "required": ["name", "age", "race", "occupation", "personality"],
      "properties": {
        "name": { "type": "string" },
        "aliases": { "type": "array", "description": "Titles, nicknames", "items": { "type": "string" } },
        "age": { "type": "integer", "minimum": 0 },
        "race": { "type": "string", "description": "Species (e.g., human, elf, demon)" },
        "gender": { "type": "string" },
        "occupation": { "type": "string" },
        "appearance": {
          "type": "object",
          "properties": {
            "height": { "type": "string", "description": "e.g., 5'8\", tall" },
            "build": { "type": "string", "description": "e.g., slim, muscular" },
            "hair": { "type": "string" },
            "eyes": { "type": "string" },
            "distinguishing_features": { "type": "array", "description": "Scars, tattoos", "items": { "type": "string" } },
            "typical_attire": { "type": "string" }
          }
        },
        "personality": {
          "type": "object",
          "description": "Core traits, values, goals",
          "required": ["traits", "values", "fears"],
          "properties": {
            "traits": { "type": "array", "description": "3-7 core traits (e.g., brave, cunning)", "items": { "type": "string" }, "minItems": 3, "maxItems": 7 },
            "values": { "type": "array", "description": "Core beliefs (e.g., honor, power)", "items": { "type": "string" }, "minItems": 2 },
            "fears": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
            "goals": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["description", "priority"],
                "properties": {
                  "description": { "type": "string" },
                  "priority": { "type": "string", "enum": ["critical", "high", "medium", "low"] },
                  "public_knowledge": { "type": "boolean", "description": "Is goal publicly known" }
                }
              }
            },
            "quirks": { "type": "array", "description": "Mannerisms, speech patterns", "items": { "type": "string" } }
          }
        },
        "backstory": { "type": "string", "description": "History, formative experiences" },
        "secrets": {
          "type": "array",
          "description": "Hidden info (player discovery required)",
          "items": {
            "type": "object",
            "required": ["secret", "severity"],
            "properties": {
              "secret": { "type": "string" },
              "severity": { "type": "string", "enum": ["minor", "moderate", "major", "world-changing"] },
              "who_knows": { "type": "array", "description": "NPC IDs aware of secret", "items": { "type": "string" } },
              "discovery_hints": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "knowledge": {
      "type": "object",
      "description": "What NPC knows/shares",
      "required": ["known_topics", "expertise_areas"],
      "properties": {
        "known_topics": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["topic", "depth"],
            "properties": {
              "topic": { "type": "string", "description": "e.g., local history, magic theory" },
              "depth": { "type": "string", "enum": ["novice", "apprentice", "journeyman", "expert", "master"] },
              "willing_to_share": { "type": "boolean", "default": true },
              "conditions_to_share": { "type": "string", "description": "Requirements (e.g., affinity≥30, 100g)" }
            }
          }
        },
        "expertise_areas": { "type": "array", "items": { "type": "string" } },
        "known_locations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "location_id": { "type": "string" },
              "familiarity": { "type": "string", "enum": ["heard_of", "visited", "frequent", "lives_there", "expert"] },
              "can_provide_directions": { "type": "boolean", "default": false }
            }
          }
        },
        "known_npcs": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "npc_id": { "type": "string" },
              "relationship": { "type": "string", "description": "e.g., friend, rival, mentor" },
              "will_introduce": { "type": "boolean" }
            }
          }
        },
        "knowledge_boundaries": {
          "type": "object",
          "description": "AIDM constraints",
          "properties": {
            "era_limit": { "type": "string", "description": "Cannot know events after this" },
            "geographic_limit": { "type": "string", "description": "Limited knowledge outside region" },
            "prohibited_knowledge": { "type": "array", "description": "Topics NPC does NOT know", "items": { "type": "string" } }
          }
        }
      }
    },
    "behavior": {
      "type": "object",
      "description": "Actions, reactions, decisions",
      "required": ["dialogue_style", "reaction_patterns"],
      "properties": {
        "dialogue_style": {
          "type": "object",
          "properties": {
            "formality": { "type": "string", "enum": ["very_formal", "formal", "neutral", "casual", "very_casual"] },
            "vocabulary": { "type": "string", "description": "Word choices, slang, tics" },
            "tone": { "type": "string", "description": "e.g., cheerful, serious, sarcastic" },
            "example_phrases": { "type": "array", "items": { "type": "string" } }
          }
        },
        "reaction_patterns": {
          "type": "object",
          "properties": {
            "to_strangers": { "type": "string", "enum": ["hostile", "suspicious", "cautious", "neutral", "friendly", "welcoming"] },
            "to_authority": { "type": "string", "enum": ["rebellious", "defiant", "resistant", "compliant", "respectful", "subservient"] },
            "to_threats": { "type": "string", "enum": ["aggressive", "defensive", "flight", "freeze", "negotiate", "surrender"] },
            "to_bribes": { "type": "string", "enum": ["offended", "resistant", "negotiable", "easily_swayed", "greedy"] },
            "to_flattery": { "type": "string", "enum": ["immune", "suspicious", "indifferent", "appreciative", "vain"] }
          }
        },
        "decision_making": {
          "type": "object",
          "properties": {
            "primary_motivation": { "type": "string", "description": "e.g., self-interest, duty, compassion" },
            "risk_tolerance": { "type": "string", "enum": ["reckless", "bold", "moderate", "cautious", "paranoid"] },
            "moral_alignment": { "type": "string", "description": "e.g., lawful good, chaotic neutral" }
          }
        },
        "combat_behavior": {
          "type": "object",
          "properties": {
            "combat_capable": { "type": "boolean" },
            "preferred_tactics": { "type": "string" },
            "retreat_threshold": { "type": "string", "enum": ["never", "near_death", "half_health", "first_injury", "immediately"] }
          }
        }
      }
    },
    "relationships": {
      "type": "object",
      "description": "Connections: player, NPCs, factions",
      "required": ["player_affinity"],
      "properties": {
        "player_affinity": { "type": "integer", "description": "Score: -100 to +100", "minimum": -100, "maximum": 100 },
        "affinity_thresholds": {
          "type": "object",
          "description": "Behavior unlock levels",
          "properties": {
            "hostile": { "type": "integer", "description": "<-50: actively hostile", "default": -50 },
            "unfriendly": { "type": "integer", "description": "<-20: cold, unhelpful", "default": -20 },
            "neutral": { "type": "integer", "default": 0 },
            "friendly": { "type": "integer", "description": ">30: helpful, warm", "default": 30 },
            "trusted": { "type": "integer", "description": ">60: shares secrets", "default": 60 },
            "devoted": { "type": "integer", "description": ">85: loyal", "default": 85 }
          }
        },
        "affinity_modifiers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["trigger", "change"],
            "properties": {
              "trigger": { "type": "string", "description": "e.g., helping villagers, insulting religion" },
              "change": { "type": "integer", "description": "+/- amount" },
              "one_time": { "type": "boolean", "default": false }
            }
          }
        },
        "interaction_history": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["session_number", "event", "affinity_change"],
            "properties": {
              "session_number": { "type": "integer" },
              "event": { "type": "string" },
              "affinity_change": { "type": "integer" },
              "memorable": { "type": "boolean", "description": "Will NPC reference later", "default": false }
            }
          }
        },
        "faction_affiliations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["faction_id", "role", "loyalty"],
            "properties": {
              "faction_id": { "type": "string" },
              "role": { "type": "string", "description": "e.g., member, officer, leader" },
              "loyalty": { "type": "integer", "description": "0-100", "minimum": 0, "maximum": 100 },
              "public_membership": { "type": "boolean" }
            }
          }
        },
        "npc_relationships": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["npc_id", "relationship_type"],
            "properties": {
              "npc_id": { "type": "string" },
              "relationship_type": { "type": "string", "description": "e.g., friend, rival, mentor, family" },
              "affinity": { "type": "integer", "description": "-100 to +100", "minimum": -100, "maximum": 100 },
              "secret_relationship": { "type": "boolean", "default": false }
            }
          }
        }
      }
    },
    "narrative_role": {
      "type": "object",
      "description": "Story function",
      "required": ["importance", "purpose"],
      "properties": {
        "importance": { "type": "string", "enum": ["background", "minor", "recurring", "major", "critical"] },
        "purpose": { "type": "array", "items": { "type": "string", "enum": ["quest_giver", "mentor", "rival", "antagonist", "ally", "love_interest", "comic_relief", "information_source", "shopkeeper", "skill_trainer", "faction_representative", "plot_catalyst", "worldbuilding", "other"] } },
        "associated_quests": { "type": "array", "items": { "type": "string" } },
        "plot_flags": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "flag_name": { "type": "string" },
              "effect": { "type": "string", "description": "What happens when flag set" }
            }
          }
        },
        "can_die": { "type": "boolean", "description": "Killable vs plot-protected" },
        "death_consequences": { "type": "string", "description": "Impact on story/quests" }
      }
    },
    "capabilities": {
      "type": "object",
      "description": "Abilities, services, resources",
      "properties": {
        "power_level": { "type": "integer", "description": "Combat power vs player (0-100)", "minimum": 0, "maximum": 100 },
        "special_abilities": { "type": "array", "items": { "type": "string" } },
        "services_offered": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "service": { "type": "string", "description": "e.g., training, crafting, healing" },
              "cost": { "type": "string", "description": "e.g., 100g, affinity≥50" },
              "availability": { "type": "string", "description": "Conditions when available" }
            }
          }
        },
        "inventory": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "item": { "type": "string" },
              "acquirable": { "type": "boolean" },
              "acquisition_method": { "type": "string", "description": "e.g., purchase, gift, theft" }
            }
          }
        }
      }
    },
    "current_state": {
      "type": "object",
      "description": "Dynamic gameplay state",
      "required": ["location", "activity"],
      "properties": {
        "location": { "type": "string" },
        "activity": { "type": "string" },
        "schedule": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "time_range": { "type": "string", "description": "e.g., morning, 9AM-12PM" },
              "location": { "type": "string" },
              "activity": { "type": "string" },
              "availability": { "type": "string", "enum": ["available", "busy", "unavailable"] }
            }
          }
        },
        "current_mood": { "type": "string", "description": "Temporary emotional override" },
        "temporary_flags": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "flag": { "type": "string", "description": "e.g., angry, injured, drunk" },
              "expires": { "type": "string" },
              "effect": { "type": "string" }
            }
          }
        }
      }
    },
    "ensemble_context": {
      "type": "object",
      "description": "Ensemble cast management data (Module 05)",
      "properties": {
        "archetype": {
          "type": "string",
          "enum": [
            "struggler",
            "heart",
            "skeptic",
            "dependent",
            "equal",
            "observer",
            "rival",
            null
          ],
          "description": "Ensemble role: struggler (growth journey), heart (emotional core), skeptic (questions PC), dependent (needs PC help), equal (peer threat), observer (witness), rival (competitive), null (not in ensemble)"
        },
        "growth_stage": {
          "type": "string",
          "enum": ["introduction", "bonding", "challenge", "growth", "mastery", null],
          "description": "Where NPC is in their arc. null if not tracked."
        },
        "spotlight_sessions": {
          "type": "array",
          "description": "Sessions where NPC had significant focus (for rotation tracking)",
          "items": { "type": "integer" }
        },
        "spotlight_total": {
          "type": "number",
          "minimum": 0,
          "description": "Total spotlight time accumulated (0-1 scale, cumulative)"
        },
        "last_spotlight_session": {
          "type": "integer",
          "description": "Most recent session with spotlight"
        },
        "milestone_history": {
          "type": "array",
          "description": "Growth milestones achieved",
          "items": {
            "type": "object",
            "required": ["stage", "session", "event"],
            "properties": {
              "stage": { "type": "string" },
              "session": { "type": "integer" },
              "event": { "type": "string", "description": "What happened" },
              "affinity_change": { "type": "integer" }
            }
          }
        },
        "subplot_arcs": {
          "type": "array",
          "description": "NPC-driven story arcs",
          "items": {
            "type": "object",
            "required": ["arc_name", "status"],
            "properties": {
              "arc_name": { "type": "string" },
              "status": { "type": "string", "enum": ["planned", "active", "paused", "resolved"] },
              "sessions_active": { "type": "integer" },
              "related_npcs": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },
    "aidm_directives": {
      "type": "object",
      "description": "AIDM handling instructions",
      "properties": {
        "reflection_required": { "type": "boolean", "description": "Reflect on personality before every response", "default": false },
        "consistency_checks": { "type": "array", "description": "Verify before NPC acts", "items": { "type": "string" } },
        "evolution_allowed": { "type": "boolean", "description": "Can personality change over time", "default": true },
        "evolution_triggers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "trigger": { "type": "string" },
              "change": { "type": "string" }
            }
          }
        },
        "protected_elements": { "type": "array", "description": "Never change these aspects", "items": { "type": "string" } }
      }
    },
    "metadata": {
      "type": "object",
      "required": ["created_date", "version"],
      "properties": {
        "created_date": { "type": "string", "format": "date-time" },
        "last_modified": { "type": "string", "format": "date-time" },
        "version": { "type": "string", "pattern": "^\\d+\\.\\d+\\.\\d+$" },
        "source_anime": { "type": "string", "description": "Inspiration source (if applicable)" },
        "archetype": { "type": "string", "description": "e.g., tsundere, kuudere, wise mentor" },
        "design_notes": { "type": "string" }
      }
    }
  }
}
